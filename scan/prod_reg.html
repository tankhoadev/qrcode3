<!DOCTYPE html>
<html>
   <head>
      <title>Scan QR Code</title>
      <script src="../jquery/1.11.3/jquery.min.js"></script>

      <script>
         const g_existCusts = [
            {
               username: "tankhoa.dev@viscor.com",
               products:
                  [
                     { prod_no: "erctb", prod_id: 2 },
                     { prod_no: "ind", prod_id: 3 }
                  ]
            }
         ];

         window.onload = window_onload;

         //#############################################################################################################################
         //Description : * 
         //-----------------------------------------------------------------------------------------------------------------------------
         function window_onload()
         {
            regEvents();

            $("#txtUrl").val(document.location.href);
            parseUrl();
         }

         //#############################################################################################################################
         //Description : * 
         //-----------------------------------------------------------------------------------------------------------------------------
         function regEvents()
         {
            $("#txtUrl").on("change", function(e) { parseUrl(); });

            $("#txtUrl").on("keydown", function(e) {
               if(e.keyCode == 13) {
                  parseUrl();
               }               
            });
         }

         //#############################################################################################################################
         //Description : * bind customer product list
         //-----------------------------------------------------------------------------------------------------------------------------
         function parseUrl()
         {
            const paramObj = getQueryParams($("#txtUrl").val());

            if(paramObj.hasOwnProperty("username") && paramObj.hasOwnProperty("prod_no") && paramObj.hasOwnProperty("prod_id"))
            {
               const cust = updateCustomers(paramObj);
               bindCustomers(cust);
            }            
         }

         //#############################################################################################################################
         //Description : * bind customer product list
         //-----------------------------------------------------------------------------------------------------------------------------
         function bindCustomers(cust)
         {
            $("#divCust").html("");

            var sHtml = `<table style='width:100%;' border='1'>
               <tr><td>Username: </td><td colspan='3'>${cust.username}</td></tr>`;               

            for(var i=0; i<cust.products.length; i++)
            {
               sHtml +=  `<tr>
                            <td>prod_no: </td><td>${cust.products[i].prod_no}</td>
                            <td>prod_id: </td><td>${cust.products[i].prod_id}</td>
                          </tr>`;
            }
            sHtml += `</table>`;

            $("#divCust").html(sHtml);
         }

         //#############################################################################################################################
         //Description : * bind customer product list
         //-----------------------------------------------------------------------------------------------------------------------------
         function updateCustomers(paramObj)
         {
            let cust = g_existCusts.find(e => e.username == paramObj["username"]);

            if(cust == null)
            {
               cust = {
                  username: paramObj["username"],
                  products: []
               }
               g_existCusts.push(cust);
            }

            cust.products.push({
                prod_no: paramObj["prod_no"], 
                prod_id: paramObj["prod_id"], 
            });

            return cust;
         }

         //#############################################################################################################################
         //Description : * parse page url 
         //-----------------------------------------------------------------------------------------------------------------------------
         function getQueryParams(sUrl)
         {
            const paramObj = {};            
            
            const paramArr = sUrl.slice(sUrl.indexOf('?') + 1).split('&');
            paramArr.map(param => {
               const [key, val] = param.split("=");
               paramObj[key] = val;
            });

            return paramObj;
         }

      </script>
   </head>
   <body>
      <table>
         <tr>
            <td>Url</td>
            <td><input id="txtUrl" style="width:800px;"/></td>
         </tr>
         <tr>
            <td>Customer products</td>
            <td><div id="divCust"></div></td>
         </tr>
      </table>      
   </body>
</html>